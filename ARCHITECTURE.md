## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              ARCHITECTURE OVERVIEW                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────────┐     ┌──────────────────────────────────────────────────────────┐  │
│   │   Client    │     │                    Docker Network                         │  │
│   │  (Browser)  │     │  ┌────────────────────────────────────────────────────┐  │  │
│   └──────┬──────┘     │  │              Application Layer                      │  │  │
│          │            │  │  ┌─────────────┐    ┌─────────────┐                 │  │  │
│          ▼            │  │  │   Nginx     │───▶│  Hono API   │                 │  │  │
│   ┌─────────────┐     │  │  │  (Reverse   │    │  (Node.js)  │                 │  │  │
│   │   Nginx     │◀────┼──┼──│   Proxy)    │    │   :3000     │                 │  │  │
│   │   :80/443   │     │  │  └─────────────┘    └──────┬──────┘                 │  │  │
│   └─────────────┘     │  │                           │                         │  │  │
│                       │  └───────────────────────────┼─────────────────────────┘  │  │
│                       │                              │                            │  │
│                       │  ┌───────────────────────────┼─────────────────────────┐  │  │
│                       │  │              Data Layer   │                         │  │  │
│                       │  │  ┌─────────────┐    ┌─────┴─────┐    ┌───────────┐  │  │  │
│                       │  │  │   Redis     │◀───│  BullMQ   │    │   MinIO   │  │  │  │
│                       │  │  │   :6379     │    │  Workers  │───▶│   :9000   │  │  │  │
│                       │  │  └─────────────┘    └───────────┘    └───────────┘  │  │  │
│                       │  └──────────────────────────────────────────────────────┘  │  │
│                       │                                                            │  │
│                       │  ┌──────────────────────────────────────────────────────┐  │  │
│                       │  │              Observability Layer                     │  │  │
│                       │  │                  ┌─────────────────┐                 │  │  │
│                       │  │                  │     Jaeger      │                 │  │  │
│                       │  │                  │     :16686      │                 │  │  │
│                       │  │                  └─────────────────┘                 │  │  │
│                       │  │                                                      │  │  │
│                       │  └──────────────────────────────────────────────────────┘  │  │
│                       └────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Architecture Diagram

### Detailed Component Interaction

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        DOWNLOAD REQUEST FLOW                                         │
└─────────────────────────────────────────────────────────────────────────────────────┘

  ┌──────────┐
  │  Client  │
  └────┬─────┘
       │
       │ 1. POST /v1/export
       │    { file_ids: [70000, 70001] }
       ▼
  ┌──────────┐     ┌───────────────┐     ┌───────────────┐
  │  Nginx   │────▶│   Hono API    │────▶│    Redis      │
  │  Proxy   │     │   (Node.js)   │     │   (BullMQ)    │
  └──────────┘     └───────┬───────┘     └───────┬───────┘
                           │                     │
       │ 2. Response:      │                     │
       │    { jobId: "abc" │                     │
       │      status: "queued" }                 │
       ▼                   │                     │
  ┌──────────┐             │                     ▼
  │  Client  │             │             ┌───────────────┐
  └────┬─────┘             │             │    Worker     │
       │                   │             │   (BullMQ)    │
       │ 3. GET /v1/download/status/:jobId              │
       │    OR                           │               │
       │    GET /v1/download/subscribe/:jobId (SSE)     │
       ▼                   │             │               │
  ┌──────────┐             │             │  4. Process   │
  │  Nginx   │────▶────────┘             │     Download  │
  │  Proxy   │                           │               │
  └────┬─────┘                           │               ▼
       │                                 │       ┌───────────────┐
       │ 5. Poll Response:               │       │     MinIO     │
       │    { status: "processing",      │       │   (S3 Store)  │
       │      progress: 45% }            │       └───────────────┘
       │                                 │
       │ 6. Final Response:              │
       │    { status: "completed",       │
       │      downloadUrl: "presigned"   │
       │    }                            │
       ▼                                 │
  ┌──────────┐                           │
  │  Client  │◀──────────────────────────┘
  └──────────┘


```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│ OBSERVABILITY DATA FLOW │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌───────────────┐ ┌───────────────┐
│ Hono API │ │ Worker │
│ (Traces) │ │ (Traces) │
└───────┬───────┘ └───────┬───────┘
│ │
│ OTLP │ OTLP
│ │
└──────────────┬──────┘
│
▼
┌───────────────┐
│ Jaeger │
│ (Traces) │
└───────────────┘

### 3. Observability Layer

#### Jaeger (Distributed Tracing)

| Property      | Value                            |
| ------------- | -------------------------------- |
| **UI Port**   | 16686                            |
| **OTLP Port** | 4318                             |
| **Features**  | OpenTelemetry collector built-in |

---

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        HYBRID PATTERN IMPLEMENTATION                                 │
└─────────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────────┐
                    │            CLIENT DECISION              │
                    │                                         │
                    │   Browser supports SSE?                 │
                    │         │                               │
                    │    ┌────┴────┐                          │
                    │    │         │                          │
                    │   YES       NO                          │
                    │    │         │                          │
                    │    ▼         ▼                          │
                    │  ┌────┐   ┌──────┐                      │
                    │  │SSE │   │Polling                      │
                    │  └────┘   └──────┘                      │
                    └─────────────────────────────────────────┘


### Job Processing Flow

```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│ JOB STATE MACHINE │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌──────────┐ ┌──────────────┐ ┌───────────┐ ┌───────────────┐
│ queued │────▶│ processing │────▶│ completed │ │ failed │
└──────────┘ └──────────────┘ └───────────┘ └───────────────┘
│ ▲
│ │
└───────────────────────────────────────┘
(on error, after retries)

## Data Flow

### Complete Request Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          COMPLETE DATA FLOW                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

PHASE 1: Job Initiation
───────────────────────
User                 Nginx               API                  Redis
 │                    │                   │                     │
 │  POST /v1/export   │                   │                     │
 │                    │                   │                     │
 │───────────────────▶│                   │                     │
 │                    │──────────────────▶│                     │
 │                    │                   │  Add to Queue       │
 │                    │                   │────────────────────▶│
 │                    │                   │                     │
 │                    │                   │  SET job:{id}       │
 │                    │                   │────────────────────▶│
 │                    │                   │                     │
 │                    │◀──────────────────│                     │
 │◀───────────────────│                   │                     │
 │  { jobId, status } │                   │                     │


PHASE 2: Background Processing
──────────────────────────────
Redis               Worker              MinIO
 │                    │                   │
 │  BRPOP job queue   │                   │
 │◀───────────────────│                   │
 │                    │                   │
 │                    │  Process file     │
 │                    │──────────────────▶│
 │                    │                   │
 │                    │  GET presigned URL│
 │                    │◀──────────────────│
 │                    │                   │
 │  UPDATE job:{id}   │                   │
 │◀───────────────────│                   │


PHASE 3: Status Updates (Polling)
─────────────────────────────────
User                 Nginx               API                  Redis
 │                    │                   │                     │
 │  GET /v1/export/:id│                   │                     │
 │───────────────────▶│                   │                     │
 │                    │──────────────────▶│                     │
 │                    │                   │  GET job:{id}       │
 │                    │                   │────────────────────▶│
 │                    │                   │◀────────────────────│
 │                    │◀──────────────────│                     │
 │◀───────────────────│                   │                     │
 │  { progress: 75 }  │                   │                     │


PHASE 3 (ALT): Status Updates (SSE)
───────────────────────────────────
User                 Nginx               API                  Redis
 │                    │                   │                     │
 │  GET /v1/export/   │                   │                     │
 │      :id/progress  │                   │                     │
 │───────────────────▶│                   │                     │
 │                    │──────────────────▶│                     │
 │                    │                   │  SUBSCRIBE job:{id} │
 │                    │                   │────────────────────▶│
 │                    │                   │                     │
 │◀─ SSE: progress ───│◀──────────────────│◀────────────────────│
 │                    │                   │                     │
 │◀─ SSE: completed ──│◀──────────────────│◀────────────────────│
```

---
