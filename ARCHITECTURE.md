# Architecture Design Document

## CUET Micro-Ops Hackathon 2025 - File Download Service

**Version**: 2.1  
**Date**: December 12, 2025  
**Author**: Hackathon Team  
**Status**: âœ… **ALL CHALLENGES COMPLETED** (Including Advanced Export System)

---

> ğŸš€ **Advanced Export System Implemented**
>
> - **Background Jobs**: BullMQ + Redis for reliable processing
> - **Real-time Updates**: Server-Sent Events (SSE) for progress tracking
> - **Resilience**: Survives browser disconnects, retries on failure
> - **Scalability**: Separate worker process, horizontal scaling ready
>
> ğŸ“Š **Download Processing Time Scenario Implementation**
> 
> This architecture handles the variable download processing times shown in the hackathon scenario:
> - ğŸŸ¢ **Fast**: 10-15 seconds (Green)
> - ğŸŸ¡ **Medium**: 30-60 seconds (Yellow)  
> - ğŸ”´ **Slow**: 60-120 seconds (Red)
>
> View real-time metrics at: **http://localhost:3001** (Grafana Dashboard)

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [System Overview](#system-overview)
3. [Architecture Diagram](#architecture-diagram)
4. [Component Details](#component-details)
5. [Long-Running Download Solution](#long-running-download-solution)
6. [Observability Stack](#observability-stack)
7. [Data Flow](#data-flow)
8. [API Design](#api-design)
9. [Proxy Configuration](#proxy-configuration)
10. [Frontend Integration](#frontend-integration)
11. [Deployment Strategy](#deployment-strategy)
12. [Security Considerations](#security-considerations)

---

## Executive Summary

This document outlines the architecture for a **long-running file download microservice** that handles variable processing times (10s-120s+) while providing excellent user experience through asynchronous processing, real-time progress updates, and comprehensive observability.

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Architecture Pattern** | Hybrid (Polling + SSE) | Best of both worlds - simple polling for basic clients, SSE for real-time UX |
| **Storage** | MinIO (S3-compatible) | Self-hosted, production-ready, no vendor lock-in |
| **Job Queue** | Redis + BullMQ | In-memory speed, persistence, battle-tested |
| **Logging** | Loki | Integrates seamlessly with Grafana, log aggregation |
| **Metrics** | Prometheus + prom-client | Industry standard, powerful querying |
| **Visualization** | Grafana | Unified dashboards for metrics and logs |
| **Tracing** | Jaeger + OpenTelemetry | Distributed tracing standard |
| **Orchestration** | Docker Compose | No Kubernetes - simpler, faster for this scale |

### Prometheus Metrics Implemented

```
http_requests_total{method, path, status}     - HTTP request counter
http_request_duration_seconds                 - Request latency histogram
downloads_active                              - Active downloads gauge
downloads_total{status}                       - Download counter (completed/failed)
download_processing_seconds{file_id, status}  - Processing time histogram
```

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ARCHITECTURE OVERVIEW                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   Client    â”‚     â”‚                    Docker Network                         â”‚  â”‚
â”‚   â”‚  (Browser)  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚              Application Layer                      â”‚  â”‚  â”‚
â”‚          â”‚            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚  â”‚
â”‚          â–¼            â”‚  â”‚  â”‚   Nginx     â”‚â”€â”€â”€â–¶â”‚  Hono API   â”‚                 â”‚  â”‚  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚  â”‚  (Reverse   â”‚    â”‚  (Node.js)  â”‚                 â”‚  â”‚  â”‚
â”‚   â”‚   Nginx     â”‚â—€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”‚   Proxy)    â”‚    â”‚   :3000     â”‚                 â”‚  â”‚  â”‚
â”‚   â”‚   :80/443   â”‚     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚                           â”‚                         â”‚  â”‚  â”‚
â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚                       â”‚                              â”‚                            â”‚  â”‚
â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚                       â”‚  â”‚              Data Layer   â”‚                         â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â”‚   Redis     â”‚â—€â”€â”€â”€â”‚  BullMQ   â”‚    â”‚   MinIO   â”‚  â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â”‚   :6379     â”‚    â”‚  Workers  â”‚â”€â”€â”€â–¶â”‚   :9000   â”‚  â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚                       â”‚                                                            â”‚  â”‚
â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚                       â”‚  â”‚              Observability Layer                     â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â”‚ Prometheus  â”‚ â”‚    Loki     â”‚ â”‚     Jaeger      â”‚ â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â”‚   :9090     â”‚ â”‚   :3100     â”‚ â”‚     :16686      â”‚ â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚         â”‚               â”‚                 â”‚          â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚                         â–¼                            â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚                 â”‚   Grafana   â”‚                      â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚                 â”‚   :3001     â”‚                      â”‚  â”‚  â”‚
â”‚                       â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚  â”‚
â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture Diagram

### Detailed Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DOWNLOAD REQUEST FLOW                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                              
  â”‚  Client  â”‚                                                              
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                              
       â”‚                                                                    
       â”‚ 1. POST /v1/export                                      
       â”‚    { file_ids: [70000, 70001] }                                    
       â–¼                                                                    
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 
  â”‚  Nginx   â”‚â”€â”€â”€â”€â–¶â”‚   Hono API    â”‚â”€â”€â”€â”€â–¶â”‚    Redis      â”‚                 
  â”‚  Proxy   â”‚     â”‚   (Node.js)   â”‚     â”‚   (BullMQ)    â”‚                 
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 
                           â”‚                     â”‚                         
       â”‚ 2. Response:      â”‚                     â”‚                         
       â”‚    { jobId: "abc" â”‚                     â”‚                         
       â”‚      status: "queued" }                 â”‚                         
       â–¼                   â”‚                     â”‚                         
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                     â–¼                         
  â”‚  Client  â”‚             â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚             â”‚    Worker     â”‚                 
       â”‚                   â”‚             â”‚   (BullMQ)    â”‚                 
       â”‚ 3. GET /v1/download/status/:jobId              â”‚                  
       â”‚    OR                           â”‚               â”‚                 
       â”‚    GET /v1/download/subscribe/:jobId (SSE)     â”‚                  
       â–¼                   â”‚             â”‚               â”‚                 
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚             â”‚  4. Process   â”‚                 
  â”‚  Nginx   â”‚â”€â”€â”€â”€â–¶â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚     Download  â”‚                 
  â”‚  Proxy   â”‚                           â”‚               â”‚                 
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                           â”‚               â–¼                 
       â”‚                                 â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         
       â”‚ 5. Poll Response:               â”‚       â”‚     MinIO     â”‚         
       â”‚    { status: "processing",      â”‚       â”‚   (S3 Store)  â”‚         
       â”‚      progress: 45% }            â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         
       â”‚                                 â”‚                                 
       â”‚ 6. Final Response:              â”‚                                 
       â”‚    { status: "completed",       â”‚                                 
       â”‚      downloadUrl: "presigned"   â”‚                                 
       â”‚    }                            â”‚                                 
       â–¼                                 â”‚                                 
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚                                 
  â”‚  Client  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                             


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        OBSERVABILITY DATA FLOW                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Hono API    â”‚     â”‚    Worker     â”‚     â”‚     Nginx     â”‚
  â”‚   (Metrics)   â”‚     â”‚   (Metrics)   â”‚     â”‚   (Metrics)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â”‚  /metrics           â”‚  /metrics           â”‚  /metrics
          â”‚                     â”‚                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                     â”‚
                         â–¼                     â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
                 â”‚  Prometheus   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚   (Scrape)    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚              â”‚
          â–¼              â–¼              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚     Loki      â”‚     â”‚      â”‚    Jaeger     â”‚
  â”‚    (Logs)     â”‚     â”‚      â”‚   (Traces)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚             â”‚              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚    Grafana    â”‚
                â”‚  (Dashboard)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Details

### 1. Application Layer

#### Hono API Server (Node.js)

| Property | Value |
|----------|-------|
| **Framework** | Hono (ultra-fast web framework) |
| **Runtime** | Node.js 24 with native TypeScript |
| **Port** | 3000 |
| **Features** | OpenAPI docs, rate limiting, security headers |

```typescript
// Key responsibilities:
- Accept download requests
- Queue jobs to Redis/BullMQ
- Serve status endpoints (polling + SSE)
- Expose Prometheus metrics
- Send logs to Loki via stdout
- Emit OpenTelemetry traces
```

#### Nginx Reverse Proxy

| Property | Value |
|----------|-------|
| **Port** | 80 (HTTP), 443 (HTTPS) |
| **Timeout** | 300s for long-polling |
| **Features** | Load balancing, SSL termination, buffering |

### 2. Data Layer

#### Redis (Job Queue & Cache)

| Property | Value |
|----------|-------|
| **Port** | 6379 |
| **Purpose** | BullMQ job queue, session cache |
| **Persistence** | RDB snapshots + AOF |

#### MinIO (S3-Compatible Storage)

| Property | Value |
|----------|-------|
| **API Port** | 9000 |
| **Console Port** | 9001 |
| **Bucket** | `downloads` |
| **Features** | Presigned URLs, lifecycle policies |

### 3. Observability Layer

#### Prometheus (Metrics)

| Property | Value |
|----------|-------|
| **Port** | 9090 |
| **Scrape Interval** | 15s |
| **Retention** | 15 days |
| **Targets** | API, Workers, Nginx, MinIO |

#### Loki (Logs)

| Property | Value |
|----------|-------|
| **Port** | 3100 |
| **Retention** | 7 days |
| **Sources** | All containers via Docker driver |

#### Grafana (Visualization)

| Property | Value |
|----------|-------|
| **Port** | 3001 |
| **Data Sources** | Prometheus, Loki, Jaeger |
| **Features** | Pre-configured dashboards |

#### Jaeger (Distributed Tracing)

| Property | Value |
|----------|-------|
| **UI Port** | 16686 |
| **OTLP Port** | 4318 |
| **Features** | OpenTelemetry collector built-in |

---

## Long-Running Download Solution

### Chosen Pattern: **Hybrid Approach (Polling + SSE)**

We implement **Option D: Hybrid Approach** combining the best aspects of polling and Server-Sent Events.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HYBRID PATTERN IMPLEMENTATION                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            CLIENT DECISION              â”‚
                    â”‚                                         â”‚
                    â”‚   Browser supports SSE?                 â”‚
                    â”‚         â”‚                               â”‚
                    â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                          â”‚
                    â”‚    â”‚         â”‚                          â”‚
                    â”‚   YES       NO                          â”‚
                    â”‚    â”‚         â”‚                          â”‚
                    â”‚    â–¼         â–¼                          â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”                      â”‚
                    â”‚  â”‚SSE â”‚   â”‚Polling                      â”‚
                    â”‚  â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POLLING PATH:                          SSE PATH:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. POST /v1/export                     1. POST /v1/export
2. Returns: { jobId: "abc" }           2. Returns: { jobId: "abc" }
3. GET /v1/export/abc                  3. GET /v1/export/abc/progress
   (every 2-5 seconds)                    (single connection)
4. Response: {                         4. Server pushes events:
     status: "processing",                event: progress
     progress: 45                         data: { progress: 45 }
   }                                      
5. When completed:                     5. event: completed
   { status: "completed",                 data: { downloadUrl: "..." }
     downloadUrl: "..." }
```

### Why Hybrid?

| Requirement | Polling | SSE | Hybrid |
|-------------|---------|-----|--------|
| Simple clients | âœ… | âŒ | âœ… |
| Real-time UX | âŒ | âœ… | âœ… |
| Proxy compatibility | âœ… | âš ï¸ | âœ… |
| Connection efficiency | âŒ | âœ… | âœ… |
| Graceful degradation | âŒ | âŒ | âœ… |

### Job Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          JOB STATE MACHINE                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  queued  â”‚â”€â”€â”€â”€â–¶â”‚  processing  â”‚â”€â”€â”€â”€â–¶â”‚ completed â”‚     â”‚    failed     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                                       â–²
                           â”‚                                       â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      (on error, after retries)

Job States:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ queued      - Job accepted, waiting in queue
â€¢ processing  - Worker actively processing
â€¢ completed   - Successfully finished, URL ready
â€¢ failed      - All retry attempts exhausted
```

### Database/Cache Schema (Redis)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          REDIS KEY STRUCTURE                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Job Data (Hash)
job:{jobId}
â”œâ”€â”€ status      : "queued" | "processing" | "completed" | "failed"
â”œâ”€â”€ progress    : 0-100
â”œâ”€â”€ fileId      : number
â”œâ”€â”€ createdAt   : ISO timestamp
â”œâ”€â”€ updatedAt   : ISO timestamp
â”œâ”€â”€ downloadUrl : presigned URL (when completed)
â”œâ”€â”€ error       : error message (when failed)
â””â”€â”€ attempts    : retry count

# User Sessions (Set)
user:{userId}:jobs â†’ Set of jobIds

# Job Queue (BullMQ managed)
bull:export-queue:wait    â†’ List of waiting jobs
bull:export-queue:active  â†’ List of active jobs
bull:export-queue:failed  â†’ List of failed jobs

# TTL Settings
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
job:{jobId}          â†’ 24 hours
user:{userId}:jobs   â†’ 7 days
```

### Background Job Processing (BullMQ)

```typescript
// Worker Configuration
const exportQueue = new Queue('file-exports', {
  connection: redis,
  defaultJobOptions: {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 5000,  // Start with 5s, then 10s, 20s
    },
    removeOnComplete: {
      age: 86400,   // Keep completed jobs for 24h
      count: 1000,  // Keep last 1000 jobs
    },
    removeOnFail: {
      age: 604800,  // Keep failed jobs for 7 days
    },
  },
});

// Worker Process
const worker = new Worker('file-exports', async (job) => {
  const { fileIds, userId } = job.data;
  
  // Update progress during processing
  await job.updateProgress({
    percent: 0,
    currentFile: 0,
    totalFiles: fileIds.length,
    stage: "processing",
    message: "Starting export..."
  });
  
  // Simulate/perform download processing and S3 upload
  const result = await processExportJob(job);
  
  return result;
}, {
  connection: redis,
  concurrency: 3,  // Process 3 jobs simultaneously
});
```

### Error Handling & Retry Logic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ERROR HANDLING STRATEGY                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Retry Configuration:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Max attempts: 3
â€¢ Backoff: Exponential (5s â†’ 10s â†’ 20s)
â€¢ Retry on: Network errors, S3 timeouts
â€¢ No retry on: Invalid file_id, Permission denied

Error Categories:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Error Type     â”‚ HTTP Status â”‚ Retry?         â”‚ Action          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Validation     â”‚ 400         â”‚ No             â”‚ Return error    â”‚
â”‚ Not Found      â”‚ 404         â”‚ No             â”‚ Return error    â”‚
â”‚ S3 Timeout     â”‚ 504         â”‚ Yes (3x)       â”‚ Exponential BO  â”‚
â”‚ Network Error  â”‚ 503         â”‚ Yes (3x)       â”‚ Exponential BO  â”‚
â”‚ Internal Error â”‚ 500         â”‚ Yes (1x)       â”‚ Log + Alert     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Timeout Configuration

```yaml
# Timeout at Each Layer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer            â”‚ Timeout    â”‚ Reason                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nginx Proxy      â”‚ 300s       â”‚ Allow SSE/long-polling             â”‚
â”‚ API Request      â”‚ 30s        â”‚ Quick response for job initiation  â”‚
â”‚ SSE Connection   â”‚ 600s       â”‚ Keep-alive for progress updates    â”‚
â”‚ Worker Job       â”‚ 180s       â”‚ Max processing time + buffer       â”‚
â”‚ S3 Operations    â”‚ 60s        â”‚ Upload/download timeout            â”‚
â”‚ Redis Operations â”‚ 5s         â”‚ Fast cache operations              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Observability Stack

### Metrics (Prometheus)

```yaml
# Key Metrics to Track
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Metric Name                      â”‚ Type      â”‚ Description         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ http_requests_total              â”‚ Counter   â”‚ Total HTTP requests â”‚
â”‚ http_request_duration_seconds    â”‚ Histogram â”‚ Request latency     â”‚
â”‚ export_jobs_total                â”‚ Counter   â”‚ Jobs by status      â”‚
â”‚ export_job_duration_seconds      â”‚ Histogram â”‚ Job processing time â”‚
â”‚ export_queue_size                â”‚ Gauge     â”‚ Queue depth         â”‚
â”‚ s3_operations_total              â”‚ Counter   â”‚ S3 ops by type      â”‚
â”‚ s3_operation_duration_seconds    â”‚ Histogram â”‚ S3 latency          â”‚
â”‚ active_sse_connections           â”‚ Gauge     â”‚ SSE client count    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Logging (Loki)

```json
// Structured Log Format
{
  "level": "info",
  "timestamp": "2025-12-12T10:30:00Z",
  "service": "delineate-api",
  "traceId": "abc123",
  "spanId": "def456",
  "requestId": "req-789",
  "message": "Download job started",
  "context": {
    "jobId": "job-123",
    "fileId": 70000,
    "userId": "user-456"
  }
}
```

### Dashboards (Grafana)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          GRAFANA DASHBOARDS                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard 1: API Overview
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request Rate    â”‚ â”‚ Error Rate      â”‚ â”‚ P99 Latency     â”‚
â”‚ 1.2K req/min    â”‚ â”‚ 0.02%           â”‚ â”‚ 245ms           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Request Duration Distribution                  â”‚
â”‚  â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard 2: Download Jobs
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Queue Depth     â”‚ â”‚ Processing      â”‚ â”‚ Success Rate    â”‚
â”‚ 42 jobs         â”‚ â”‚ 5 active        â”‚ â”‚ 99.8%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Job Processing Time by File Size               â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard 3: Infrastructure
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CPU Usage       â”‚ â”‚ Memory Usage    â”‚ â”‚ Disk I/O        â”‚
â”‚ 23%             â”‚ â”‚ 1.2GB/4GB       â”‚ â”‚ 45MB/s          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow

### Complete Request Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          COMPLETE DATA FLOW                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PHASE 1: Job Initiation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User                 Nginx               API                  Redis
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚  POST /v1/export   â”‚                   â”‚                     â”‚
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚                     â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚
 â”‚                    â”‚                   â”‚  Add to Queue       â”‚
 â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚                    â”‚                   â”‚  SET job:{id}       â”‚
 â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                     â”‚
 â”‚  { jobId, status } â”‚                   â”‚                     â”‚


PHASE 2: Background Processing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Redis               Worker              MinIO               Loki
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚  BRPOP job queue   â”‚                   â”‚                   â”‚
 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                   â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚                    â”‚  Process file     â”‚                   â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚                    â”‚  Log progress     â”‚                   â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚                    â”‚  GET presigned URLâ”‚                   â”‚
 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚  UPDATE job:{id}   â”‚                   â”‚                   â”‚
 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                   â”‚


PHASE 3: Status Updates (Polling)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User                 Nginx               API                  Redis
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚  GET /v1/export/:idâ”‚                   â”‚                     â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚                     â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚
 â”‚                    â”‚                   â”‚  GET job:{id}       â”‚
 â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚                    â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                     â”‚
 â”‚  { progress: 75 }  â”‚                   â”‚                     â”‚


PHASE 3 (ALT): Status Updates (SSE)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User                 Nginx               API                  Redis
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚  GET /v1/export/   â”‚                   â”‚                     â”‚
 â”‚      :id/progress  â”‚                   â”‚                     â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚                     â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚
 â”‚                    â”‚                   â”‚  SUBSCRIBE job:{id} â”‚
 â”‚                    â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚â—€â”€ SSE: progress â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                   â”‚                     â”‚
 â”‚â—€â”€ SSE: completed â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

---

## API Design

### New Endpoints Required

```yaml
# Existing Endpoints (Modified)
POST /v1/export
  - Now returns jobId immediately
  - Job queued for background processing

# New Endpoints
GET /v1/export/:jobId
  - Poll for job status
  - Returns: { status, progress, downloadUrl?, error? }

GET /v1/export/:jobId/progress
  - SSE endpoint for real-time updates
  - Events: progress, completed, failed

GET /v1/export/:jobId/download
  - Get final download details
  - Returns presigned URL when ready

# Health & Metrics
GET /metrics
  - Prometheus metrics endpoint
```

### API Contract

```typescript
// POST /v1/export
// Request
{
  "file_ids": [70000, 70001, 70002]
}

// Response (200 OK)
{
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued",
  "totalFiles": 3,
  "createdAt": "2025-12-12T10:30:00Z"
}

// GET /v1/download/status/:jobId
// Response (200 OK)
{
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing",  // queued | processing | completed | failed
  "progress": 45,
  "currentFile": 2,
  "totalFiles": 3,
  "updatedAt": "2025-12-12T10:31:00Z"
}

// GET /v1/download/status/:jobId (completed)
// Response (200 OK)
{
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "progress": 100,
  "downloadUrl": "https://minio:9000/downloads/archive.zip?X-Amz-...",
  "expiresAt": "2025-12-12T11:30:00Z",
  "completedAt": "2025-12-12T10:32:00Z"
}

// GET /v1/download/subscribe/:jobId (SSE)
// Response (200 OK, text/event-stream)
event: progress
data: {"progress": 10, "currentFile": 1}

event: progress
data: {"progress": 45, "currentFile": 2}

event: completed
data: {"downloadUrl": "https://...", "expiresAt": "..."}
```

---

## Proxy Configuration

### Nginx Configuration

```nginx
# /etc/nginx/conf.d/delineate.conf

upstream api {
    server delineate-app:3000;
    keepalive 32;
}

server {
    listen 80;
    server_name localhost;

    # Gzip compression
    gzip on;
    gzip_types application/json text/event-stream;

    # Standard API requests
    location /v1/ {
        proxy_pass http://api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Request-ID $request_id;
        
        # Standard timeout
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
    }

    # SSE endpoint (long-running)
    location /v1/download/subscribe/ {
        proxy_pass http://api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Connection '';
        
        # SSE specific settings
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 600s;  # 10 minutes
        
        # Chunked encoding for SSE
        chunked_transfer_encoding on;
    }

    # Status polling (moderate timeout)
    location /v1/download/status/ {
        proxy_pass http://api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        proxy_read_timeout 60s;
    }

    # Health check
    location /health {
        proxy_pass http://api;
        proxy_read_timeout 5s;
    }

    # Prometheus metrics
    location /metrics {
        proxy_pass http://api;
        proxy_read_timeout 5s;
    }
}
```

### Cloudflare Configuration

```yaml
# Cloudflare Page Rules / Configuration

# Rule 1: SSE Endpoints
URL Pattern: */v1/download/subscribe/*
Settings:
  - Disable Performance (caching)
  - WebSockets: On (enables long connections)
  - Rocket Loader: Off
  - Browser Integrity Check: Off

# Rule 2: API Endpoints
URL Pattern: */v1/*
Settings:
  - Cache Level: Bypass
  - Security Level: High

# Timeout Note:
# Cloudflare Enterprise: Can increase to 600s
# Cloudflare Pro/Free: 100s limit - use polling pattern
```

---

## Frontend Integration

### React/Next.js Implementation

```typescript
// hooks/useDownload.ts
import { useState, useEffect, useCallback } from 'react';

interface DownloadJob {
  jobId: string;
  status: 'queued' | 'processing' | 'completed' | 'failed';
  progress: number;
  downloadUrl?: string;
  error?: string;
}

export function useDownload() {
  const [job, setJob] = useState<DownloadJob | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  // Initiate download
  const initiateDownload = useCallback(async (fileIds: number[]) => {
    setIsLoading(true);
    
    const response = await fetch('/v1/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ file_ids: fileIds }),
    });
    
    const data = await response.json();
    setJob({ ...data, progress: 0 });
    setIsLoading(false);
    
    // Start SSE subscription
    subscribeToUpdates(data.jobId);
    
    return data;
  }, []);

  // SSE subscription with fallback to polling
  const subscribeToUpdates = useCallback((jobId: string) => {
    // Try SSE first
    if (typeof EventSource !== 'undefined') {
      const eventSource = new EventSource(`/v1/download/subscribe/${jobId}`);
      
      eventSource.addEventListener('progress', (e) => {
        const data = JSON.parse(e.data);
        setJob(prev => prev ? { ...prev, ...data } : null);
      });
      
      eventSource.addEventListener('completed', (e) => {
        const data = JSON.parse(e.data);
        setJob(prev => prev ? { 
          ...prev, 
          status: 'completed',
          progress: 100,
          downloadUrl: data.downloadUrl 
        } : null);
        eventSource.close();
      });
      
      eventSource.addEventListener('failed', (e) => {
        const data = JSON.parse(e.data);
        setJob(prev => prev ? { 
          ...prev, 
          status: 'failed',
          error: data.error 
        } : null);
        eventSource.close();
      });
      
      eventSource.onerror = () => {
        eventSource.close();
        // Fallback to polling
        pollForUpdates(jobId);
      };
    } else {
      // Browser doesn't support SSE
      pollForUpdates(jobId);
    }
  }, []);

  // Polling fallback
  const pollForUpdates = useCallback(async (jobId: string) => {
    const poll = async () => {
      const response = await fetch(`/v1/download/status/${jobId}`);
      const data = await response.json();
      
      setJob(data);
      
      if (data.status === 'queued' || data.status === 'processing') {
        setTimeout(poll, 2000);  // Poll every 2 seconds
      }
    };
    
    poll();
  }, []);

  // Cancel download
  const cancelDownload = useCallback(async () => {
    if (!job?.jobId) return;
    
    await fetch(`/v1/download/${job.jobId}`, {
      method: 'DELETE',
    });
    
    setJob(null);
  }, [job?.jobId]);

  return {
    job,
    isLoading,
    initiateDownload,
    cancelDownload,
  };
}
```

### UI Component

```tsx
// components/DownloadProgress.tsx
import { useDownload } from '../hooks/useDownload';

export function DownloadProgress() {
  const { job, isLoading, initiateDownload, cancelDownload } = useDownload();

  return (
    <div className="download-container">
      {!job && (
        <button 
          onClick={() => initiateDownload([70000, 70001])}
          disabled={isLoading}
        >
          {isLoading ? 'Starting...' : 'Start Download'}
        </button>
      )}
      
      {job && (
        <div className="progress-card">
          <div className="status-badge" data-status={job.status}>
            {job.status.toUpperCase()}
          </div>
          
          <div className="progress-bar">
            <div 
              className="progress-fill" 
              style={{ width: `${job.progress}%` }}
            />
          </div>
          
          <span className="progress-text">{job.progress}%</span>
          
          {job.status === 'completed' && job.downloadUrl && (
            <a 
              href={job.downloadUrl} 
              className="download-button"
              download
            >
              Download File
            </a>
          )}
          
          {job.status === 'failed' && (
            <div className="error-message">
              Error: {job.error}
              <button onClick={() => initiateDownload([70000])}>
                Retry
              </button>
            </div>
          )}
          
          {(job.status === 'queued' || job.status === 'processing') && (
            <button onClick={cancelDownload} className="cancel-button">
              Cancel
            </button>
          )}
        </div>
      )}
    </div>
  );
}
```

### Handling Edge Cases

```typescript
// utils/downloadManager.ts

class DownloadManager {
  private activeJobs = new Map<string, EventSource>();

  // Handle browser close during download
  setupUnloadHandler() {
    window.addEventListener('beforeunload', (e) => {
      if (this.activeJobs.size > 0) {
        e.preventDefault();
        e.returnValue = 'Downloads in progress. Are you sure you want to leave?';
      }
    });
  }

  // Handle network reconnection
  setupNetworkHandler(jobId: string) {
    window.addEventListener('online', () => {
      console.log('Network restored, resuming job status...');
      this.resubscribe(jobId);
    });

    window.addEventListener('offline', () => {
      console.log('Network lost, pausing updates...');
      this.closeConnection(jobId);
    });
  }

  // Handle concurrent downloads
  async initiateMultiple(fileIdGroups: number[][]) {
    const jobs = await Promise.all(
      fileIdGroups.map(fileIds => 
        fetch('/v1/export', {
          method: 'POST',
          body: JSON.stringify({ file_ids: fileIds }),
        }).then(r => r.json())
      )
    );

    return jobs;
  }
}
```

---

## Deployment Strategy

### Docker Compose Architecture (No Kubernetes)

```yaml
# Service Dependencies
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SERVICE STARTUP ORDER                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Level 1 (No dependencies):
â”œâ”€â”€ redis
â”œâ”€â”€ minio
â”œâ”€â”€ loki
â””â”€â”€ jaeger

Level 2 (Depends on Level 1):
â”œâ”€â”€ prometheus (depends: minio, api)
â””â”€â”€ grafana (depends: prometheus, loki, jaeger)

Level 3 (Depends on Level 1 & 2):
â”œâ”€â”€ delineate-app (depends: redis, minio, jaeger)
â””â”€â”€ delineate-worker (depends: redis, minio)

Level 4 (Depends on all):
â””â”€â”€ nginx (depends: delineate-app)
```

### Environment-Specific Configs

```
Development:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Hot reload enabled
â€¢ Verbose logging
â€¢ All ports exposed
â€¢ Mock data available
â€¢ Quick timeouts (5-15s delays)

Production:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Multi-replica support
â€¢ Secrets from environment
â€¢ Limited port exposure
â€¢ Resource limits
â€¢ Full timeouts (10-120s delays)
```

---

## Security Considerations

### Security Checklist

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SECURITY MEASURES                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Input Validation
   â€¢ Zod schemas for all inputs
   â€¢ File ID range validation (10K-100M)
   â€¢ Path traversal prevention

âœ… Rate Limiting
   â€¢ 100 requests/minute default
   â€¢ Per-IP tracking
   â€¢ Configurable limits

âœ… Security Headers
   â€¢ HSTS enabled
   â€¢ X-Frame-Options: DENY
   â€¢ X-Content-Type-Options: nosniff
   â€¢ CSP headers

âœ… Secrets Management
   â€¢ No secrets in code
   â€¢ Environment variables
   â€¢ .env files (gitignored)

âœ… S3 Security
   â€¢ Presigned URLs (expire in 1h)
   â€¢ No public bucket access
   â€¢ IAM-style credentials

âœ… Network Security
   â€¢ Internal Docker network
   â€¢ Only Nginx exposed
   â€¢ No direct DB access

âœ… Observability Security
   â€¢ Grafana auth enabled
   â€¢ Prometheus behind proxy
   â€¢ No PII in logs
```

---

## Service Port Summary

| Service | Internal Port | External Port | Purpose |
|---------|---------------|---------------|---------|
| **Nginx** | 80 | 80 | HTTP Reverse Proxy |
| **Hono API** | 3000 | 3000 (dev only) | Application Server |
| **MinIO API** | 9000 | 9000 | S3-Compatible Storage |
| **MinIO Console** | 9001 | 9001 | Storage Admin UI |
| **Redis** | 6379 | 6379 (dev only) | Job Queue & Cache |
| **Prometheus** | 9090 | 9090 | Metrics Collection |
| **Loki** | 3100 | 3100 | Log Aggregation |
| **Grafana** | 3000 | 3001 | Dashboards |
| **Jaeger** | 16686 | 16686 | Tracing UI |
| **Jaeger OTLP** | 4318 | 4318 | Trace Collection |

---

## Quick Start

```bash
# Development
docker compose -f docker/compose.dev.yml up --build

# Production
docker compose -f docker/compose.prod.yml up --build -d

# Access Points
- API Docs:     http://localhost:3000/docs
- Grafana:      http://localhost:3001 (admin/admin)
- MinIO:        http://localhost:9001 (minioadmin/minioadmin)
- Jaeger:       http://localhost:16686
- Prometheus:   http://localhost:9090
```

---

## Appendix

### A. Technology Decision Matrix

| Category | Options Considered | Selected | Rationale |
|----------|-------------------|----------|-----------|
| **Web Framework** | Express, Fastify, Hono | Hono | Ultra-fast, native TS, modern API |
| **Job Queue** | BullMQ, Agenda, Bee | BullMQ | Redis-backed, reliable, feature-rich |
| **S3 Storage** | MinIO, SeaweedFS, LocalStack | MinIO | Production-ready, S3 compatible |
| **Metrics** | Prometheus, InfluxDB, Graphite | Prometheus | Industry standard, PromQL power |
| **Logging** | Loki, ELK, Graylog | Loki | Grafana native, lightweight |
| **Tracing** | Jaeger, Zipkin, Tempo | Jaeger | Mature, great UI, OTLP support |
| **Orchestration** | Kubernetes, Docker Compose, Nomad | Docker Compose | Simple, sufficient for scale |

### B. Glossary

| Term | Definition |
|------|------------|
| **SSE** | Server-Sent Events - unidirectional server-to-client streaming |
| **BullMQ** | Node.js message queue library built on Redis |
| **Presigned URL** | Time-limited URL granting temporary access to S3 objects |
| **OTLP** | OpenTelemetry Protocol for transmitting telemetry data |
| **PromQL** | Prometheus Query Language for metric analysis |

---

*Document Version: 1.0 | Last Updated: December 12, 2025*
